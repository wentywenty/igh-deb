#!/bin/bash
set -e

# Prevent execution on host during build stage
if [ "${HOST_BUILD_STAGE:-0}" -eq 1 ]; then
    exit 0
fi

KERNEL_VER=$(uname -r)

# Update module dependencies
# Use -F if System.map exists, otherwise run depmod -a
if [ -f "/boot/System.map-$KERNEL_VER" ]; then
    depmod -F "/boot/System.map-$KERNEL_VER" "$KERNEL_VER"
else
    depmod -a "$KERNEL_VER"
fi

# Remove PATH configuration on purge
if [ "$1" = "purge" ] || [ "$1" = "remove" ]; then
    PROFILE_FILE="/etc/profile.d/ethercat.sh"
    if [ -f "$PROFILE_FILE" ]; then
        echo "Removing EtherCAT PATH configuration..."
        rm -f "$PROFILE_FILE"
    fi
fi

exit 0
